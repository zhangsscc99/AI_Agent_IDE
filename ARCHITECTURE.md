# ğŸ—ï¸ æ¶æ„è®¾è®¡æ–‡æ¡£

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æµè§ˆå™¨å‰ç«¯                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  FileExplorer   â”‚   CodeEditor    â”‚      ChatPanel          â”‚
â”‚   (æ–‡ä»¶æ ‘)       â”‚  (Monacoç¼–è¾‘å™¨)  â”‚      (AIå¯¹è¯)            â”‚
â”‚                 â”‚                 â”‚                         â”‚
â”‚  - æ–‡ä»¶æµè§ˆ      â”‚  - è¯­æ³•é«˜äº®      â”‚  - æµå¼å¯¹è¯              â”‚
â”‚  - ç›®å½•å±•å¼€      â”‚  - è‡ªåŠ¨è¡¥å…¨      â”‚  - å·¥å…·è°ƒç”¨æ˜¾ç¤º          â”‚
â”‚  - æ–‡ä»¶é€‰æ‹©      â”‚  - Diff è§†å›¾     â”‚  - å®æ—¶åé¦ˆ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTP / SSE
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Next.js API å±‚                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  /api/agent/chat          â”‚  /api/workspace/files           â”‚
â”‚  - SSE æµå¼å“åº”            â”‚  - æ–‡ä»¶åˆ—è¡¨                      â”‚
â”‚  - Agent æ‰§è¡Œ              â”‚  - æ–‡ä»¶è¯»å–                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Agent æ ¸å¿ƒå±‚                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    AgentExecutor (executor.ts)               â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ LLM Client   â”‚  â”‚ Tool System  â”‚  â”‚Memory Managerâ”‚      â”‚
â”‚  â”‚ (llm.ts)     â”‚  â”‚ (tools.ts)   â”‚  â”‚ (memory.ts)  â”‚      â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚      â”‚
â”‚  â”‚ - GLM-4.6    â”‚  â”‚ - read_file  â”‚  â”‚ - å¯¹è¯å†å²    â”‚      â”‚
â”‚  â”‚ - OpenAI     â”‚  â”‚ - write_file â”‚  â”‚ - æ–‡ä»¶æ“ä½œ    â”‚      â”‚
â”‚  â”‚ - Claude     â”‚  â”‚ - list_files â”‚  â”‚ - ä»»åŠ¡ç»“æœ    â”‚      â”‚
â”‚  â”‚              â”‚  â”‚ - apply_patchâ”‚  â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                  â”‚                  â”‚
           â†“                  â†“                  â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ GLM API â”‚        â”‚æ–‡ä»¶ç³»ç»Ÿ  â”‚        â”‚SQLite DBâ”‚
    â”‚(æ™ºè°±AI) â”‚        â”‚(Workspace)â”‚        â”‚(agent.db)â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1ï¸âƒ£ Agent Executor (æ‰§è¡Œå™¨)

**æ–‡ä»¶**: `lib/agent/executor.ts`

**èŒè´£**: Agent çš„å¤§è„‘ï¼Œåè°ƒæ‰€æœ‰æ¨¡å—

**æ‰§è¡Œæµç¨‹**:
```typescript
async *execute(userMessage: string) {
  // 1. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°è®°å¿†
  memoryManager.addMemory(...)
  
  // 2. è·å–å¯¹è¯å†å²
  const recentMemories = memoryManager.getRecentConversations(...)
  
  // 3. æ„å»ºæ¶ˆæ¯åˆ—è¡¨
  const messages = [systemPrompt, ...history, userMessage]
  
  // 4. è°ƒç”¨ LLM (æµå¼)
  for await (const chunk of llmClient.streamChat(messages, tools)) {
    // å®æ—¶è¾“å‡º
    yield { type: 'message', content: chunk.delta }
    
    // å¤„ç†å·¥å…·è°ƒç”¨
    if (chunk.tool_calls) {
      const result = await executeTool(...)
      yield { type: 'tool_result', data: result }
    }
  }
  
  // 5. ä¿å­˜å®Œæ•´å“åº”åˆ°è®°å¿†
  memoryManager.addMemory(...)
}
```

**ç‰¹æ€§**:
- âœ… æµå¼è¾“å‡ºï¼ˆSSEï¼‰
- âœ… å·¥å…·è°ƒç”¨å¾ªç¯
- âœ… è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤§ 10 æ¬¡è¿­ä»£ï¼‰
- âœ… é”™è¯¯å¤„ç†

### 2ï¸âƒ£ LLM Client (å¤§æ¨¡å‹å®¢æˆ·ç«¯)

**æ–‡ä»¶**: `lib/agent/llm.ts`

**èŒè´£**: ç»Ÿä¸€çš„ LLM API æ¥å£

**æ”¯æŒçš„æä¾›å•†**:
```typescript
interface LLMConfig {
  provider: 'glm' | 'openai' | 'claude'
  apiKey: string
  baseUrl?: string
  model: string
}
```

**API å…¼å®¹æ€§**:
| æä¾›å•† | Base URL | å…¼å®¹ OpenAI æ ¼å¼ |
|--------|----------|------------------|
| GLM-4.6 | `https://open.bigmodel.cn/api/paas/v4` | âœ… |
| OpenAI | `https://api.openai.com/v1` | âœ… |
| Claude | `https://api.anthropic.com/v1` | ğŸ”„ (éœ€è½¬æ¢) |

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
// æµå¼å¯¹è¯
async *streamChat(messages, tools, temperature)

// éæµå¼å¯¹è¯
async chat(messages, tools, temperature)
```

### 3ï¸âƒ£ Tool System (å·¥å…·ç³»ç»Ÿ)

**æ–‡ä»¶**: `lib/agent/tools.ts`

**èŒè´£**: æä¾› Agent å¯è°ƒç”¨çš„å·¥å…·

**å·¥å…·æ³¨å†Œè¡¨**:
```typescript
const TOOLS = {
  read_file: Tool,      // è¯»å–æ–‡ä»¶
  write_file: Tool,     // å†™å…¥æ–‡ä»¶
  list_files: Tool,     // åˆ—å‡ºæ–‡ä»¶
  apply_patch: Tool,    // åº”ç”¨è¡¥ä¸
  create_patch: Tool,   // åˆ›å»ºè¡¥ä¸
}
```

**å·¥å…·æ¥å£**:
```typescript
interface Tool {
  name: string
  description: string
  parameters: JSONSchema
  execute: (params) => Promise<any>
}
```

**å¦‚ä½•æ·»åŠ æ–°å·¥å…·**:
```typescript
export const myNewTool: Tool = {
  name: 'my_new_tool',
  description: 'å·¥å…·æè¿°',
  parameters: {
    type: 'object',
    properties: {
      param1: { type: 'string', description: 'å‚æ•°æè¿°' }
    },
    required: ['param1']
  },
  execute: async ({ param1, workspacePath }) => {
    // å·¥å…·é€»è¾‘
    return { success: true, data: '...' }
  }
}

// æ·»åŠ åˆ°æ³¨å†Œè¡¨
TOOLS.my_new_tool = myNewTool
```

### 4ï¸âƒ£ Memory Manager (è®°å¿†ç®¡ç†)

**æ–‡ä»¶**: `lib/agent/memory.ts`

**èŒè´£**: æŒä¹…åŒ–å­˜å‚¨å¯¹è¯å’Œæ“ä½œå†å²

**æ•°æ®ç»“æ„**:
```sql
CREATE TABLE memories (
  id TEXT PRIMARY KEY,
  session_id TEXT NOT NULL,
  type TEXT NOT NULL,  -- conversation | file_operation | task_result
  content TEXT NOT NULL,
  metadata TEXT,       -- JSON æ ¼å¼
  created_at INTEGER NOT NULL
);
```

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
class MemoryManager {
  addMemory(memory)                        // æ·»åŠ è®°å¿†
  getMemories(sessionId, limit)            // è·å–æ‰€æœ‰è®°å¿†
  getRecentConversations(sessionId, limit) // è·å–å¯¹è¯å†å²
  getFileOperations(sessionId, filePath)   // è·å–æ–‡ä»¶æ“ä½œå†å²
  clearSession(sessionId)                  // æ¸…é™¤ä¼šè¯
}
```

**è®°å¿†ç±»å‹**:
- `conversation`: å¯¹è¯å†å²ï¼ˆç”¨æˆ·å’Œ AI çš„æ¶ˆæ¯ï¼‰
- `file_operation`: æ–‡ä»¶æ“ä½œè®°å½•ï¼ˆåˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤ï¼‰
- `task_result`: ä»»åŠ¡æ‰§è¡Œç»“æœ

## æ•°æ®æµ

### ç”¨æˆ·å‘é€æ¶ˆæ¯ â†’ AI å“åº”

```
1. ç”¨æˆ·è¾“å…¥: "åˆ›å»ºä¸€ä¸ª hello.py æ–‡ä»¶"
   â†“
2. ChatPanel è°ƒç”¨: POST /api/agent/chat
   â†“
3. API Route åˆ›å»º AgentExecutor
   â†“
4. Executor æ‰§è¡Œ:
   a. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ° Memory
   b. è·å–å¯¹è¯å†å²
   c. è°ƒç”¨ LLM (æµå¼)
   d. LLM è¿”å› tool_call: write_file
   e. æ‰§è¡Œå·¥å…·: write_file({ path: 'hello.py', content: '...' })
   f. ä¿å­˜æ–‡ä»¶æ“ä½œåˆ° Memory
   g. å°†ç»“æœè¿”å›ç»™ LLM
   h. LLM æ€»ç»“: "å·²åˆ›å»º hello.py"
   â†“
5. SSE æµå¼è¿”å›ç»™å‰ç«¯:
   - type: 'message' â†’ "æˆ‘æ¥å¸®ä½ åˆ›å»º..."
   - type: 'tool_call' â†’ "è°ƒç”¨å·¥å…·: write_file"
   - type: 'tool_result' â†’ "å·¥å…·æ‰§è¡ŒæˆåŠŸ"
   - type: 'message' â†’ "å·²æˆåŠŸåˆ›å»º hello.py"
   - type: 'done'
   â†“
6. ChatPanel å®æ—¶æ˜¾ç¤º
   â†“
7. FileExplorer è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯ 3 ç§’ï¼‰
```

## æŠ€æœ¯é€‰å‹ç†ç”±

### å‰ç«¯

| æŠ€æœ¯ | é€‰æ‹©ç†ç”± |
|------|---------|
| **Next.js 14** | å…¨æ ˆæ¡†æ¶ï¼Œæ”¯æŒ SSR å’Œ API Routesï¼Œå¼€å‘æ•ˆç‡é«˜ |
| **Monaco Editor** | VS Code åŒæ¬¾ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒè¯­æ³•é«˜äº®å’Œè‡ªåŠ¨è¡¥å…¨ |
| **Tailwind CSS** | å¿«é€Ÿæ„å»º UIï¼Œå“åº”å¼è®¾è®¡ |
| **TypeScript** | ç±»å‹å®‰å…¨ï¼Œå‡å°‘ bug |

### åç«¯

| æŠ€æœ¯ | é€‰æ‹©ç†ç”± |
|------|---------|
| **Next.js API Routes** | ç®€åŒ–éƒ¨ç½²ï¼Œå‰åç«¯ç»Ÿä¸€ |
| **Better-SQLite3** | è½»é‡çº§ï¼Œé›¶é…ç½®ï¼Œé€‚åˆå•æœºåº”ç”¨ |
| **SSE** | æµå¼å“åº”ï¼Œå®æ—¶åé¦ˆï¼Œæ¯” WebSocket ç®€å• |

### Agent

| æŠ€æœ¯ | é€‰æ‹©ç†ç”± |
|------|---------|
| **è‡ªç ”çŠ¶æ€æœº** | çµæ´»å¯æ§ï¼Œæ˜“äºè°ƒè¯•å’Œæ‰©å±• |
| **Function Calling** | æ ‡å‡†åŒ–å·¥å…·è°ƒç”¨ï¼Œå…¼å®¹å¤šä¸ª LLM |
| **SQLite Memory** | æŒä¹…åŒ–ï¼Œå¯è¿½æº¯ï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢ |

## æ‰©å±•æ€§è®¾è®¡

### å¦‚ä½•æ·»åŠ æ–°çš„ LLM æä¾›å•†

1. åœ¨ `lib/agent/llm.ts` ä¸­æ·»åŠ é…ç½®
2. å®ç°æ¶ˆæ¯æ ¼å¼è½¬æ¢ï¼ˆå¦‚æœéœ€è¦ï¼‰
3. æ›´æ–°ç¯å¢ƒå˜é‡

### å¦‚ä½•æ·»åŠ æ–°å·¥å…·

1. åœ¨ `lib/agent/tools.ts` ä¸­å®šä¹‰å·¥å…·
2. å®ç° `execute` æ–¹æ³•
3. æ·»åŠ åˆ° `TOOLS` æ³¨å†Œè¡¨

### å¦‚ä½•å®ç°å¤š Agent

```typescript
// æœªæ¥æ‰©å±•
class MultiAgentOrchestrator {
  plannerAgent: AgentExecutor   // è§„åˆ’ä»»åŠ¡
  executorAgent: AgentExecutor  // æ‰§è¡Œä»»åŠ¡
  reviewerAgent: AgentExecutor  // å®¡æŸ¥ç»“æœ
  
  async execute(task: string) {
    const plan = await this.plannerAgent.execute(task)
    const result = await this.executorAgent.execute(plan)
    const review = await this.reviewerAgent.execute(result)
    return review
  }
}
```

## æ€§èƒ½ä¼˜åŒ–

### å½“å‰å®ç°
- âœ… æµå¼å“åº”ï¼ˆé™ä½é¦–å­—èŠ‚æ—¶é—´ï¼‰
- âœ… è‡ªåŠ¨åˆ·æ–°æ–‡ä»¶æ ‘ï¼ˆ3 ç§’é—´éš”ï¼‰
- âœ… SQLite ç´¢å¼•ï¼ˆsession_id, created_atï¼‰

### å¯ä¼˜åŒ–æ–¹å‘
- [ ] æ–‡ä»¶æ ‘å¢é‡æ›´æ–°ï¼ˆWebSocketï¼‰
- [ ] å‘é‡æ£€ç´¢ï¼ˆFAISS/Chromaï¼‰
- [ ] LLM å“åº”ç¼“å­˜
- [ ] ä»£ç è¡¥å…¨æœ¬åœ°åŒ–

## å®‰å…¨æ€§

### å½“å‰æªæ–½
- âœ… è·¯å¾„å®‰å…¨æ£€æŸ¥ï¼ˆé˜²æ­¢ç›®å½•éå†ï¼‰
- âœ… API Key ç¯å¢ƒå˜é‡éš”ç¦»
- âœ… å·¥ä½œç©ºé—´æ²™ç®±ï¼ˆæ¯ä¸ª session ç‹¬ç«‹ç›®å½•ï¼‰

### å»ºè®®å¢å¼º
- [ ] ç”¨æˆ·è®¤è¯
- [ ] Rate Limiting
- [ ] æ–‡ä»¶å¤§å°é™åˆ¶
- [ ] ä»£ç æ‰§è¡Œæ²™ç®±

## éƒ¨ç½²å»ºè®®

### å¼€å‘ç¯å¢ƒ
```bash
npm run dev
```

### ç”Ÿäº§ç¯å¢ƒ
```bash
npm run build
npm run start
```

### Docker éƒ¨ç½²
```dockerfile
FROM node:20-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build
CMD ["npm", "start"]
```

---

ğŸ“š **å®Œæ•´çš„æ¶æ„è®¾è®¡ï¼ŒåŠ©ä½ æ·±å…¥ç†è§£ç³»ç»Ÿï¼**




