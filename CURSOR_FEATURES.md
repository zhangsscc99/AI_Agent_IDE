# 🚀 Cursor 风格智能代码审批系统

## ✨ 新增功能

### 1. 智能文件推断
AI 可以根据上下文自动推断要修改哪个文件，无需明确指定。

**示例**：
```
用户："给 two_sum 加点注释"
AI：自动识别是 two_sum.py 文件
```

### 2. Diff 可视化审批
修改代码时，会显示专业的 Diff 视图：
- **绿色背景** - 新增的代码
- **红色背景** - 删除的代码
- **并排对比** - 左右分屏显示修改前后

### 3. 安全审批机制
- AI 提出修改后**不会立即执行**
- 显示完整的 Diff 预览
- 用户必须**勾选确认**
- 点击"应用修改"才会真正修改文件

### 4. 流式对话体验
- AI 边思考边输出
- 实时显示工具调用过程
- 解释每一步操作

## 🎯 工作流程

```
用户输入
  ↓
AI 分析意图
  ↓
读取文件 (read_file)
  ↓
生成新代码
  ↓
【暂停】显示 Diff 视图
  ↓
用户查看修改
  ↓
勾选确认框
  ↓
点击"应用修改"
  ↓
文件被修改 ✅
  ↓
编辑器自动刷新
```

## 📖 使用示例

### 示例 1：修改当前打开的文件
```
1. 在左侧点击 two_sum.py
2. 输入："添加详细的中文注释"
3. AI 读取文件并生成带注释的版本
4. 显示 Diff 视图（绿色高亮新增的注释）
5. 勾选确认，点击"应用修改"
6. 完成 ✅
```

### 示例 2：不指定文件名
```
用户："给求和函数加注释"
AI：推断可能是 two_sum.py
AI：读取文件
AI：显示 Diff
用户：确认应用
```

### 示例 3：创建新文件
```
用户："创建一个 utils.py 工具类"
AI：生成代码
AI：显示 Diff（原文件为空）
用户：确认创建
```

## 🎨 界面说明

### Diff 视图组件

```
┌─────────────────────────────────────┐
│ 🤖 AI 建议修改  two_sum.py          │
│                    ☑ 我确认这些修改  │
├─────────────────────────────────────┤
│         原文件    │     修改后       │
│  ─────────────────┼──────────────── │
│  def two_sum():   │ def two_sum():  │
│      pass         │     # 注释...   │ ← 绿色
│                   │     pass        │
├─────────────────────────────────────┤
│ ● 新增  |  ● 删除        [拒绝] [✓ 应用修改] │
└─────────────────────────────────────┘
```

### 按钮说明
- **拒绝** - 取消本次修改
- **应用修改** - 只有勾选确认框后才能点击

## 🔧 技术实现

### 核心组件
1. **DiffViewer.tsx** - Diff 可视化组件
   - 使用 Monaco Editor 的 DiffEditor
   - 绿色/红色高亮
   - 勾选确认机制

2. **Agent Executor** - 智能执行器
   - 自动拦截 `write_file` 调用
   - 读取原文件内容
   - 生成 Diff 数据
   - 请求用户审批

3. **Approval API** - 审批接口
   - `/api/agent/approve`
   - 接收用户确认
   - 应用文件修改

### 数据流
```typescript
// 1. AI 调用 write_file
write_file({ path: 'file.py', content: 'new code' })

// 2. Executor 拦截
→ 读取原文件
→ 生成事件: approval_required

// 3. 前端显示 Diff
→ 用户查看
→ 用户勾选确认
→ 点击应用

// 4. 调用 API
POST /api/agent/approve
{ approved: true, content: 'new code' }

// 5. 文件被修改
→ 编辑器刷新
```

## 🎯 与 Cursor 的对比

| 功能 | Cursor | 我们的实现 |
|------|--------|-----------|
| Diff 可视化 | ✅ | ✅ |
| 绿色/红色高亮 | ✅ | ✅ |
| 用户确认机制 | ✅ | ✅ 勾选框 |
| 智能文件推断 | ✅ | ✅ |
| 流式输出 | ✅ | ✅ |
| 并排对比 | ✅ | ✅ |
| 多文件编辑 | ✅ | 🚧 未来支持 |

## 💡 使用技巧

### 1. 不用总是选文件
```
❌ 旧方式："请修改 practice_agent/two_sum.py"
✅ 新方式："给求和函数加注释"（AI 自动推断）
```

### 2. 放心让 AI 修改
所有修改都需要你确认，不会乱改代码

### 3. 仔细查看 Diff
绿色高亮 = 新增内容
红色高亮 = 删除内容

### 4. 拒绝后可以重新尝试
点"拒绝"后，可以换个说法重新让 AI 修改

## 🐛 常见问题

**Q: Diff 视图不显示？**
A: 刷新浏览器，确保 Monaco Editor 加载完成

**Q: AI 找不到文件？**
A: 明确告诉 AI 文件路径，如 "修改 two_sum.py"

**Q: 能同时修改多个文件吗？**
A: 当前版本一次只能修改一个文件，未来会支持

**Q: 如何取消修改？**
A: 点击"拒绝"按钮

---

🎉 **现在你有了一个类似 Cursor 的智能代码编辑器！**


